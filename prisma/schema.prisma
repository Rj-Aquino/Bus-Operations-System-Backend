generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Quota_Policy {
  QuotaPolicyID String @id
  StartDate     DateTime @default(now())
  EndDate       DateTime @default(dbgenerated("(CURRENT_TIMESTAMP + interval '1 year')"))
  RegularBusAssignmentID String

  Fixed Fixed?
  Percentage Percentage?

  regularBusAssignment RegularBusAssignment? @relation(fields: [RegularBusAssignmentID], references: [RegularBusAssignmentID])

  CreatedAt DateTime @default(now())
  UpdatedAt DateTime @updatedAt
  CreatedBy String?
  UpdatedBy String?
}

model Fixed {
  FQuotaPolicyID String @id
  Quota Float 

  quotaPolicy Quota_Policy @relation(fields: [FQuotaPolicyID], references: [QuotaPolicyID], onDelete: Cascade)

  CreatedAt DateTime @default(now())
  UpdatedAt DateTime @updatedAt
  CreatedBy String?
  UpdatedBy String?
}

model Percentage {
  PQuotaPolicyID String @id
  Percentage     Float

  quotaPolicy Quota_Policy @relation(fields: [PQuotaPolicyID], references: [QuotaPolicyID], onDelete: Cascade)

  CreatedAt DateTime @default(now())
  UpdatedAt DateTime @updatedAt
  CreatedBy String?
  UpdatedBy String?
}

model Stop {
  StopID     String @id
  StopName   String
  latitude   String
  longitude  String
  IsDeleted  Boolean @default(false)

  routesAsStart Route[] @relation("StartStop")
  routesAsEnd   Route[] @relation("EndStop")
  RouteStops    RouteStop[]

  CreatedAt DateTime @default(now())
  UpdatedAt DateTime @updatedAt
  CreatedBy String?
  UpdatedBy String?
}

model Route {
  RouteID     String @id
  StartStopID String
  EndStopID   String
  RouteName   String
  IsDeleted   Boolean @default(false)

  StartStop Stop @relation("StartStop", fields: [StartStopID], references: [StopID])
  EndStop   Stop @relation("EndStop", fields: [EndStopID], references: [StopID])
  RouteStops RouteStop[]
  BusAssignments BusAssignment[]

  CreatedAt DateTime @default(now())
  UpdatedAt DateTime @updatedAt
  CreatedBy String?
  UpdatedBy String?
}

model RouteStop {
  RouteStopID String @id
  RouteID     String
  StopID      String
  StopOrder   Int

  Route Route @relation(fields: [RouteID], references: [RouteID])
  Stop  Stop  @relation(fields: [StopID], references: [StopID])

  @@unique([RouteID, StopID])

  CreatedAt DateTime @default(now())
  UpdatedAt DateTime @updatedAt
  CreatedBy String?
  UpdatedBy String?
}

enum BusOperationStatus {
  NotStarted
  NotReady
  InOperation
}

enum AssignmentType {
  Regular
  Rental
}

model BusAssignment {
  BusAssignmentID String @id
  BusID           String
  RouteID         String?

  AssignmentType  AssignmentType @default(Regular)

  Battery         Boolean @default(false)
  Lights          Boolean @default(false)
  Oil             Boolean @default(false)
  Water           Boolean @default(false)
  Brake           Boolean @default(false)
  Air             Boolean @default(false)
  Gas             Boolean @default(false)
  Engine          Boolean @default(false)
  TireCondition   Boolean @default(false)
  Self_Driver     Boolean @default(false)
  Self_Conductor  Boolean @default(false)
  IsDeleted       Boolean @default(false)
  Status          BusOperationStatus @default(NotReady)

  Route Route? @relation(fields: [RouteID], references: [RouteID])

  RegularBusAssignment RegularBusAssignment?
  RentalBusAssignment  RentalBusAssignment?

  DamageReports DamageReport[]

  @@index([BusID])

  CreatedAt DateTime @default(now())
  UpdatedAt DateTime @updatedAt
  CreatedBy String?
  UpdatedBy String?
}

model RegularBusAssignment {
  RegularBusAssignmentID String @id
  DriverID               String 
  ConductorID            String 
  BusAssignment          BusAssignment @relation(fields: [RegularBusAssignmentID], references: [BusAssignmentID])

  QuotaPolicies Quota_Policy[]
  BusTrips BusTrip[]

  LatestBusTripID String? @unique
  LatestBusTrip   BusTrip? @relation("LatestBusTrip", fields: [LatestBusTripID], references: [BusTripID])

  @@index([DriverID])
  @@index([ConductorID])

  CreatedAt DateTime @default(now())
  UpdatedAt DateTime @updatedAt
  CreatedBy String?
  UpdatedBy String?
}

enum PaymentMethod {
  Reimbursement
  Company_Cash
}

model BusTrip {
  BusTripID              String   @id
  RegularBusAssignmentID String
  DispatchedAt           DateTime?
  CompletedAt            DateTime?
  Sales                  Float?
  PettyCash             Float?
  Remarks                String? 
  TripExpense            Float?
  Payment_Method         PaymentMethod?

  IsRevenueRecorded      Boolean  @default(false)
  IsExpenseRecorded      Boolean  @default(false)

  regularBusAssignment RegularBusAssignment @relation(fields: [RegularBusAssignmentID], references: [RegularBusAssignmentID])
  TicketBusTrips TicketBusTrip[]

  LatestForAssignment RegularBusAssignment? @relation("LatestBusTrip")

  CreatedAt DateTime @default(now())
  UpdatedAt DateTime @updatedAt
  CreatedBy String?
  UpdatedBy String?
}

model TicketType {
  TicketTypeID   String @id
  Value          Float
  TicketBusTrips TicketBusTrip[]

  @@map("Ticket_Type")

  CreatedAt DateTime @default(now())
  UpdatedAt DateTime @updatedAt
  CreatedBy String?
  UpdatedBy String?
}

model TicketBusTrip {
  TicketBusTripID String @id
  BusTripID       String
  TicketTypeID    String
  StartingIDNumber Int?
  EndingIDNumber   Int?
  OverallEndingID    Int? 

  BusTrip    BusTrip    @relation(fields: [BusTripID], references: [BusTripID])
  TicketType TicketType @relation(fields: [TicketTypeID], references: [TicketTypeID])

  @@map("TicketBusTripAssignment")

  CreatedAt DateTime @default(now())
  UpdatedAt DateTime @updatedAt
  CreatedBy String?
  UpdatedBy String?
}

model RentalBusAssignment {
  RentalBusAssignmentID String @id
  BusAssignment         BusAssignment @relation(fields: [RentalBusAssignmentID], references: [BusAssignmentID])

  // Relations
  RentalDrivers         RentalDriver[]
  RentalRequests        RentalRequest[]

  CreatedAt             DateTime @default(now())
  UpdatedAt             DateTime @updatedAt
  CreatedBy             String?
  UpdatedBy             String?
}

model RentalDriver {
  RentalDriverID       String @id
  RentalBusAssignmentID String
  DriverID             String

  // Relation to RentalBusAssignment
  RentalBusAssignment RentalBusAssignment @relation(fields: [RentalBusAssignmentID], references: [RentalBusAssignmentID])

  @@unique([RentalBusAssignmentID, DriverID]) 

  CreatedAt DateTime @default(now())
  UpdatedAt DateTime @updatedAt
  CreatedBy String?
  UpdatedBy String?
}

enum RentalRequestStatus {
  Pending
  Approved
  Rejected
  Completed
}

model RentalRequest {
  RentalRequestID        String   @id
  RentalBusAssignmentID  String?

  RouteName              String
  Pickuplatitude         String
  Pickuplongitude        String
  Dropofflatitude        String
  Dropofflongitude       String

  DistanceKM             Float   // Distance in kilometers
  NumberOfPassengers     Int
  RentalDate             DateTime
  Duration               Int     // Number of days instead of ExpectedArrivalTime

  SpecialRequirements    String?
  Status                 RentalRequestStatus @default(Pending)

  AutoRejectReason       String?

  CustomerName           String
  CustomerContact        String
  CustomerEmail          String
  
  IDType                 String
  IDNumber               String
  HomeAddress            String
  IDImage                String

  // Payment Fields
  TotalRentalAmount      Float              // Final computed rental cost
  DownPaymentAmount      Float?             // Amount paid upfront (optional if unpaid)
  BalanceAmount          Float?             // Remaining amount owed
  DownPaymentDate        DateTime?
  FullPaymentDate        DateTime?

  // Cancellation Fields
  CancelledAtDate        DateTime?
  CancelledReason        String?

  // Relation to RentalBusAssignment
  RentalBusAssignment    RentalBusAssignment? @relation(fields: [RentalBusAssignmentID], references: [RentalBusAssignmentID])

  IsDeleted              Boolean  @default(false)

  CreatedAt              DateTime @default(now())
  UpdatedAt              DateTime @updatedAt
  CreatedBy              String?
  UpdatedBy              String?
}

enum DamageReportStatus {
  NA
  Pending
  Accepted
  Rejected
}

model DamageReport {
  DamageReportID         String   @id
  BusAssignmentID  String

  // Vehicle condition checks (true = OK/no damage, false = damaged/issue found)
  Battery                Boolean  @default(true)
  Lights                 Boolean  @default(true)
  Oil                    Boolean  @default(true)
  Water                  Boolean  @default(true)
  Brake                  Boolean  @default(true)
  Air                    Boolean  @default(true)
  Gas                    Boolean  @default(true)
  Engine                 Boolean  @default(true)
  TireCondition          Boolean  @default(true)

  // Additional notes
  Note                   String?

  // When the damage check was performed
  CheckDate              DateTime @default(now())

  // Status of the damage report
  Status                 DamageReportStatus @default(NA)

  // Relations
  BusAssignment    BusAssignment @relation(fields: [BusAssignmentID], references: [BusAssignmentID], onDelete: Cascade)
  MaintenanceWork        MaintenanceWork?

  CreatedAt              DateTime @default(now())
  UpdatedAt              DateTime @updatedAt
  CreatedBy              String?
  UpdatedBy              String?
}

enum MaintenanceStatus {
  Pending
  InProgress
  Completed
  Cancelled
}

enum MaintenancePriority {
  Low
  Medium
  High
  Critical
}

model MaintenanceWork {
  MaintenanceWorkID      String   @id
  DamageReportID         String   @unique

  // Maintenance details
  Status                 MaintenanceStatus @default(Pending)
  Priority               MaintenancePriority @default(Medium)
  
  WorkTitle              String?  // Title/summary of the maintenance work
  
  ScheduledDate          DateTime?
  DueDate                DateTime?  // Target completion date
  CompletedDate          DateTime?
  
  EstimatedCost          Float?
  ActualCost             Float?
  
  WorkNotes              String?  // Additional notes from maintenance team
  
  // Relation to DamageReport (one-to-one)
  DamageReport           DamageReport @relation(fields: [DamageReportID], references: [DamageReportID], onDelete: Cascade)

  // Relation to Tasks (one-to-many)
  Tasks                  Task[]

  CreatedAt              DateTime @default(now())
  UpdatedAt              DateTime @updatedAt
  CreatedBy              String?
  UpdatedBy              String?
}

enum TaskStatus {
  Pending
  InProgress
  Completed
}

enum TaskType {
  Inspection     // Checking, diagnosing, verifying issues
  Repair         // Fixing damaged parts
  Replacement    // Removing and installing parts
  Cleaning       // General cleaning or clearing debris
  Testing        // Testing system performance or safety checks
  Documentation  // Reporting, logging, paperwork
  Other          // Catch-all for special/rare cases
}

model Task {
  TaskID                 String   @id
  MaintenanceWorkID      String
  
  TaskName               String
  TaskType               TaskType 
  TaskDescription        String?
  
  AssignedTo             String?  // Specific mechanic assigned to this task
  Status                 TaskStatus @default(Pending)
  
  StartDate              DateTime?
  CompletedDate          DateTime?
  EstimatedHours         Float?
  ActualHours            Float?
  
  Notes                  String?
  
  // Relation to MaintenanceWork (many-to-one)
  MaintenanceWork        MaintenanceWork @relation(fields: [MaintenanceWorkID], references: [MaintenanceWorkID], onDelete: Cascade)
  ToolsUsed              TaskTool[]

  CreatedAt              DateTime @default(now())
  UpdatedAt              DateTime @updatedAt
  CreatedBy              String?
  UpdatedBy              String?

  @@index([MaintenanceWorkID])
  @@index([Status])
}

enum ToolSourceType {
  FromInventory       // Pulled from warehouse stock
  PurchasedExternally // Bought because no inventory was available
}

model TaskTool {
  TaskToolID        String   @id
  TaskID            String

  ToolID            String?      // Reference to external inventory item (if exists)
  QuantityUsed      Float
  Unit              String       

  SourceType        ToolSourceType @default(FromInventory)

  CostPerUnit       Float?
  TotalCost         Float?

  Notes             String?

  Task              Task     @relation(fields: [TaskID], references: [TaskID], onDelete: Cascade)

  CreatedAt         DateTime @default(now())
  UpdatedAt         DateTime @updatedAt
  CreatedBy              String?
  UpdatedBy              String?

  @@index([TaskID])
  @@index([ToolID])
}